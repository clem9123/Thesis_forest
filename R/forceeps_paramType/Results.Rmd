---
title: "Analysis of the effect of the parameter: `param_type` in Forceeps"
author: "Clementine de Montgolfier"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: pdf_document
---

```{r options, include=FALSE}
# set working dir for all chunks to ..
knitr::opts_knit$set(root.dir = "../../")
opts_chunk$set(echo=FALSE)
```

# Abstract

This report presents an in-depth analysis of the effect of the `param_type` parameter on the probability of being cut and on the cutting score in the Forceps model. The study combines a theoretical approach based on the model's equations and a practical application on simulated data. The results provide a better understanding of how this parameter influences stand structure and cutting dynamics.

# Introduction

Forest management relies on cutting decisions influenced by parameters such as tree diameter and selection indices. The Forceps model formalizes the probability of cutting as a function of a cutting type parameter (`param_type`), which modulates randomness and selectivity in harvesting. This report details the effect of this parameter through a theoretical study and a practical simulation.

# Theoretical study: Effect of the `param_type` parameter

In the Forceps model, the probability that a tree is cut depends on its diameter (or circumference, denoted $c_i$) and the cutting type parameter $p$ (`param_type` in the code). The following equations govern the calculation:

**Definition of variables:**
- $c_{\text{Min}}$: minimum circumference (here 0)
- $c_{\text{Max}}$: maximum circumference (here 200)
- $c_i$: circumference of tree $i$
- $p$: cutting type parameter, between 0 and 1

**Calculation of randomness:**
\[\text{randomness} =
\begin{cases}
2p & \text{if } p \leq 0.5 \\
2 - 2p & \text{if } p > 0.5
\end{cases}
\]

**Calculation of the circumference of maximum probability:**
\[c_{\text{maxProba}} = p \times (c_{\text{Max}} - c_{\text{Min}}) + c_{\text{Min}}\]

**Calculation of the range (rangeMax):**
\[\text{rangeMax}_1 = c_{\text{maxProba}} - c_{\text{Min}} + 1\]
\[\text{rangeMax}_2 = -c_{\text{maxProba}} + c_{\text{Max}} + 1\]
\[\text{rangeMax} = \max(\text{rangeMax}_1, \text{rangeMax}_2)\]

**Probability of being cut:**
\[\text{probaOfBeingCut} = 1 - \frac{|c_i - c_{\text{maxProba}}|}{\text{rangeMax}}\]

**Cutting score (weighting between randomness and selectivity):**
\[\text{score} = \text{randomness} \times \text{uniformProba} + (1 - \text{randomness}) \times \text{probaOfBeingCut}\]
where $\text{uniformProba}$ is set to 0.5 for visualization.

These equations express the trade-off between random cutting (high `randomness` value) and selective cutting centered on a diameter class (low `randomness` value). The parameter $p$ modulates this trade-off.

# Visualisation of effects

The following plots illustrate the evolution of the probability of being cut and the score as a function of $p$ and tree diameter.

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)

# Constants from your example
cMin <- 0
cMax <- 200
ci_values <- c(30, 60, 100, 150, 200)  # different tree circumferences

# Create a data frame of param_type and ci combinations
param_types <- seq(0, 1, length.out = 5)

df <- expand.grid(param_type = param_types, ci = ci_values)

# Function to compute probaOfBeingCut
df <- df %>%
  rowwise() %>%
  mutate(
    # Compute randomness based on param_type
    randomness = if (param_type <= 0.5) {
      2 * param_type
    } else {
      2 - 2 * param_type
    },
    # circOfMaxProba
    circOfMaxProba = param_type * (cMax - cMin) + cMin,
    # initial rangeMax
    rangeMax1 = circOfMaxProba - cMin + 1,
    # alternative rangeMax
    rangeMax2 = -circOfMaxProba + cMax + 1,
    # rangeMax = max of both
    rangeMax = max(rangeMax1, rangeMax2),
    # assuming uniformProba = 0.5 (for visualization only)
    uniformProba = 0.5,
    probaOfBeingCut = 1 - abs(ci - circOfMaxProba) / rangeMax,
    score = randomness * uniformProba + (1 - randomness) * probaOfBeingCut
  ) %>%
  ungroup()

# Plot
ggplot(df, aes(x = param_type, y = probaOfBeingCut)) +
  geom_line(color = "steelblue", size = 1.2) +
  facet_wrap(~ ci, scales = "free_y") +
  labs(
    title = "Evolution of probaOfBeingCut vs param_type",
    x = "Parameter Type",
    y = "Probability of Being Cut"
  ) +
  theme_minimal()

# ProbaofbeingCut vs ci for different param_type
ggplot(df, aes(x = ci, y = probaOfBeingCut, color = as.factor(param_type))) +
  geom_line(size = 1.2) +
  labs(
    title = "ProbaOfBeingCut vs ci for different param_type",
    x = "Tree Circumference (cm)",
    y = "Probability of Being Cut",
    color = "Param Type"
  ) +
  theme_minimal()

# les plots pour le score
ggplot(df, aes(x = param_type, y = score)) +
  geom_line(color = "steelblue", size = 1.2) +
  facet_wrap(~ ci, scales = "free_y") +
  labs(
    title = "Evolution of score vs param_type",
    x = "Parameter Type",
    y = "Score"
  ) +
  theme_minimal() +
  ylim(0,1)

ggplot(df, aes(x = ci, y = score, color = as.factor(param_type))) +
  geom_line(size = 1.2) +
  labs(
    title = "Score vs ci for different param_type",
    x = "Tree Circumference (cm)",
    y = "Score",
    color = "Param Type"
  ) +
  theme_minimal() +
  ylim(0,1)
```

# Practical application: Simulation on a Fagus sylvatica forest

A simulation is performed on a beech forest (FSyl), with a 12-year rotation, target basal area of 15 m²/ha, initial basal area of 34 m²/ha, and 20 trees uniformly distributed between 0 and 80 cm in diameter. For each trajectory we use one and the same `param_type` value (0 to 1) for every cutting action during the 80 years of simulation.

```{r}
load("data/forceeps_output/paramType_complete.RData")
data <- itinerary_data
```

# Analysis of results

The results are analyzed according to several indicators:
- Mean basal area and stem density in each trajectory
- Gini coefficient (diameter structure)
- Distribution of diameter classes before and after cutting

```{r}
# en moyennant sur les rep
data_mean <- data %>%
  group_by(date, type, speciesShortName, rep) %>%
  summarise(
    meanBasalArea = sum(basalArea.m2),
    density = n(),
    .groups = 'drop'
  ) %>%
  group_by(date, type, speciesShortName) %>%
  summarise(
    meanBasalArea = mean(meanBasalArea),
    medianBasalArea = median(meanBasalArea),
    meandensity = mean(density),
    mediandensity = mean(density),
    .groups = 'drop'
  )

data_plot <- bind_rows(data_mean) #, data_total)

# plot
ggplot(data_plot) +
  geom_line(aes(x = date, y = meanBasalArea, color = speciesShortName, linetype = speciesShortName == "Total"), size = 1) +
  scale_linetype_manual(values = c("FALSE" = "solid", "TRUE" = "dashed"), guide = "none") +
  facet_wrap(~ type) +
  labs(
    title = "Mean basal area by species (and total)",
    x = "Date",
    y = "Mean basal area (m²)"
  ) +
  theme(legend.text = element_text(size = 12), legend.title = element_text(size = 14))

ggplot(data_mean) +
    geom_line(aes(x = date, y = meandensity, color = speciesShortName)) +
    facet_wrap(~ type) +
    labs(
        title = "Mean density by species",
        x = "Date",
        y = "Mean density (trees/ha)"
    ) +
    # ecrire la legende en plus grand
    theme(legend.text = element_text(size = 12), legend.title = element_text(size = 14))

# Coefficient de gini

# First, calculate Gini per (date, type, rep)
gini_data <- data %>%
  group_by(date, type, rep) %>%
  summarise(
    gini = {
      x <- dbh.cm
      n <- length(x)
      x_sorted <- sort(x)
      G <- (2 * sum((1:n) * x_sorted) - (n + 1) * sum(x_sorted)) / (n * sum(x_sorted))
      G
    },
    .groups = 'drop'
  )

# plot
ggplot(gini_data %>%
    group_by(date, type) %>% 
    summarise(gini = mean(gini)), 
    aes(x = date, y = gini, color = factor(type))) +
  geom_line() +
  labs(
    title = "Gini coefficient by type",
    x = "Date",
    y = "Gini coefficient"
  ) +
  # color gradiant for type (but scale is not continuous)
  scale_color_viridis_d(option = "plasma", begin = 0, end = 1) +
  theme_minimal()
```

# Diameter class distribution in 2021 and just after cutting

```{r}
data %>%
  filter(date %in% c(2021, 2021.1)) %>%
  group_by(date, type, speciesShortName, classe_diam, rep) %>%
  summarise(
    n = n(),
    .groups = 'drop'
  ) %>%
  group_by(date, type, speciesShortName, classe_diam) %>%
  summarise(
    n = mean(n),
    .groups = 'drop'
  ) %>%
  ggplot(aes(x = classe_diam, y = n, fill = factor(speciesShortName))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(type~date) +
  labs(
    title = "Diameter class distribution by species (2021 before and after cutting)",
    x = "Diameter class (cm)",
    y = "Number of trees"
  ) +
  theme_minimal()
```

# Conclusion

The study shows that the `param_type` parameter plays a key role in modulating cutting selectivity. A low value (close to 0) favors cutting the smallest trees with strong selectivity. As `param_type` approaches 0.5, both the average diameter of cut trees increases and the randomness of selection rises, resulting in less precise targeting. At `param_type = 0.5`, cutting is totally random. A high value (close to 1) targets the largest trees.

# References

- Forceps model code