---
title: "Retz data visualization"
author: "Clémentine de Montgolfier"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: 
  pdf_document
---

```{r options, include=FALSE}
# set working dir for all chunks to ..
knitr::opts_knit$set(root.dir = "../..")
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r libraries, include=FALSE}
library(sf)
library(tidyr)
library(readxl)
library(patchwork)
library(knitr)
library(kableExtra)
library(RColorBrewer)
```

# Préparation des données

Avec les hypothèses faites dans Import_data.R
(en particulier selection de certaines espèces)

```{r import data, include=FALSE}
load("data/retz/forest_data.RData")
especes <- colnames(forest_data)[9:36]
```

```{r, include=FALSE}
ggplot(forest_data %>% mutate(Structure.et.occupation.du.sol = factor(Structure.et.occupation.du.sol, levels = c("F", "I", "R", "S", "T", "V", "Z", "M")))) +
  geom_sf(aes(geometry = geometry, fill = Structure.et.occupation.du.sol)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank())+
  labs(title = "Occupation du sol", fill = "Structure et occupation du sol") +
  scale_fill_manual(values = c("#97e49d", "#0a6420", "#ff0000", "#28b128", "#4f9446", "#a81616", "#abb2f7", "#ff15d8"), labels = c("Futaie régulière","Irégulière","non boisé (boisable)","Taillie sous futaie","Taillis simple","non boisable","boisé hors sylviculture", "Terrain de service"))
```

Seule modification des données :  
- suppression des parcelles sans identifiant (n = 4)  
- suppression des parcelles non boisées (R non boisé boisable, V non boisable, M terrain de service) (n = 145) mais j'ai gardé les surfaces boisées hors silviculture (n=7)  

```{r functions, include=FALSE}
map_plot <- function(data, fill_var) {
  p1 <- ggplot(data) +
    geom_sf(aes(geometry = geometry, fill = !!sym(fill_var))) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank())+
    theme(legend.position = "none") +
    labs(title = fill_var)
  
  p2 <- ggplot(data, aes(x = !!sym(fill_var))) +
    geom_bar(aes(fill = !!sym(fill_var), y=(..count..)/sum(..count..))) +
    theme_minimal() +
    # écrire x penché
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
    theme(legend.position = "none") +
    labs(x = "", y = "Nombre de parcelles")
  
  p1 + p2
}
```

# Visualisation des données UEP

## Surface terrière moyenne

```{r map surface_terriere, echo=FALSE, fig.width = 12, fig.height = 6}
p1 <- ggplot(data = forest_data) +
      geom_sf(aes(geometry = geometry, fill = surf.terrière.moy)) +
      theme_minimal() +
      theme(
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())+
      scale_fill_continuous(type = "viridis") + 
      labs(title = "Surface terrière moyenne")
p2 <- ggplot(data = forest_data) +
      geom_density(aes(x = surf.terrière.moy, fill = surf.terrière.moy)) +
      theme_minimal()

p1 + p2
```

```{r map surface_terriere age, echo=FALSE, fig.width = 12, fig.height = 6}
p1 <- ggplot(data = forest_data) +
  geom_boxplot(aes(x = surf.terrière.moy, y = median_age, group = median_age, color = surf.terrière.moy)) +
  geom_point(aes(x = surf.terrière.moy, y = median_age, color = surf.terrière.moy), position = "jitter", alpha = 0.3) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Surface terrière par classe d'âge")

p2 <- ggplot(data = forest_data) +
    geom_density(aes(x = surf.terrière.moy, fill = surf.terrière.moy, color = factor(median_age))) +
    theme_minimal() +
    labs(color = "Classe d'âge")

p1 + p2
```

## Essence dominante
```{r map essence_dominante, echo=FALSE, fig.width = 12, fig.height = 6}
map_plot(forest_data, "Essence.dominante.1")
```

## Type de peuplement
```{r map type_peuplement, echo=FALSE, fig.width = 12, fig.height = 6}
palette_rainbow <- rainbow((length(unique(forest_data$Type.de.peuplement))))
type_peuplement_colors <- data.frame(palette_rainbow, sort(unique(forest_data$Type.de.peuplement)))
colnames(type_peuplement_colors) <- c("Color", "Type.de.peuplement")
p1 <- ggplot(forest_data %>% left_join(type_peuplement_colors)) +
  geom_sf(aes(geometry = geometry, fill = Type.de.peuplement)) +
  scale_fill_manual(values = type_peuplement_colors$Color, 
                    labels = type_peuplement_colors$Type.de.peuplement) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank())+
  theme(legend.position = "none") +
  labs(title = "Type de peuplement")

p2 <- ggplot(forest_data %>% left_join(type_peuplement_colors), aes(x = Type.de.peuplement)) +
  geom_bar(aes(y=(..count..)/sum(..count..), fill = Type.de.peuplement)) +
  scale_fill_manual(values = type_peuplement_colors$Color, 
                    labels = type_peuplement_colors$Type.de.peuplement) +
  theme_minimal() +
  # écrire x penché
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Nombre de parcelles")

p1 + p2
```

```{r type_peuplement_80, echo=FALSE, fig.width = 12, fig.height = 6}
forest_data %>%
  group_by(Type.de.peuplement) %>%
  summarise(Prop = n()/nrow(forest_data)) %>%
  arrange(-Prop) %>%
  mutate(Cum_Prop = cumsum(Prop)) %>%
  left_join(type_peuplement_colors) %>%
  filter(Cum_Prop <= 0.8) -> forest_data_80
```

Il y a `r nrow(forest_data_80)` peuplements qui représentent 80% des placettes.

```{r map type_peuplement_80_plot, echo=FALSE, fig.width = 6, fig.height = 6}
type_peuplement_colors <- type_peuplement_colors %>%
  filter(Type.de.peuplement %in% forest_data_80$Type.de.peuplement)

ggplot(forest_data_80, aes(x = Type.de.peuplement)) +
  geom_col(aes(y = Prop, fill = Type.de.peuplement)) +
  scale_fill_manual(values = type_peuplement_colors$Color, 
                    labels = type_peuplement_colors$Type.de.peuplement) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Nombre de parcelles")
```

Les peuplements sont :
- F des futaies (R,V non boisé)
- de HET (Hêtre), CHS (Chène sessile), CHP (Chène pédonculé), CHA (Charme), P.L. (pin laricio), DOU (Douglas), CHE (Chêne indigène)
- de différents diamètres
Les 4 plus communs (33%) Hetre M, P, E, G

## Classe de catégorie de diamètre dominant
```{r map classe_diametre, echo=FALSE, fig.width = 12, fig.height = 6}
map_plot(forest_data, "Classe.de.catégorie.de.diamètre.dominant")
```

```{r classe_diametre_tbl, echo=FALSE, fig.width = 12, fig.height = 6}	
# Create the data frame for the table
table_ccd <- data.frame(
  CODE = c("S", "E", "IR", "1", "P", "M", "G", "G-", "G+", "T"),
  LIBELLE = c(
    "REGENERATION (H<3m)",
    "EDUCATION (non commercialisable; d<10cm)",
    "IRREGULIER (pas de diamètre dominant)",
    "PERCHES (10-15cm)",
    "PETITS BOIS (20-25cm)",
    "BOIS MOYENS (30-45cm)",
    "GROS BOIS (50-65cm)",
    "proche de 50 cm",
    "proche de 65 cm",
    "TRES GROS BOIS (70cm et+)"
  )
)

# Print the table
kable(table_ccd, col.names = c("CODE", "LIBELLE"), caption = "Table CCD: Classe de catégorie de diamètre dominante")
```

## Couverture du Hêtre et du Chêne sessile

Chène sessile avec le Chène épdonculé et ensuite Charme

```{r map couverture Hetre Chene, echo=FALSE, fig.width = 12, fig.height = 6}
p1 <- ggplot(data = forest_data) +
    geom_sf(aes(geometry = geometry, fill = HET)) +
    theme_minimal() +
    theme(
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())+
    theme(legend.position = "none") +
    scale_fill_continuous(type = "viridis", na.value = "grey90") + 
    labs(title = "Hêtre")

p2 <- ggplot(data = forest_data %>% rowwise() %>% mutate(CH = sum(c(CHS, CHP), na.rm = TRUE)) %>% ungroup()) +
    geom_sf(aes(geometry = geometry, fill = CH)) +
    theme_minimal() +
    theme(
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())+
    theme(legend.position = "none") +
    scale_fill_continuous(type = "viridis", na.value = "grey90") +
    labs(title = "Chène sessile et pédonculé")

p3 <- ggplot(data = forest_data) +
    geom_sf(aes(geometry = geometry, fill = CHA)) +
    theme_minimal() +
    theme(
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank())+
    scale_fill_continuous(type = "viridis", na.value = "grey90") + 
    labs(title = "Charme", fill = "% du couvert boisé")

p1 + p2 + p3 + plot_layout(ncol = 2)
```

# Difference espèce dominante, espèce objectif

```{r, echo = FALSE, fig.width = 6}
# colonne TRUE or FALSE if the dominant species is the same as the objective species
forest_data <- forest_data %>%
  mutate(essence_diff = case_when(
    Essence.dominante.1 == ess.obj.SIG ~ "Essence dominante",
    Essence.dominante.2 == ess.obj.SIG ~ "Essence secondaire",
    TRUE ~ "Aucune")) %>%
  mutate(essence_diff = factor(essence_diff, levels = c("Essence dominante", "Essence secondaire", "Aucune")))


ggplot(forest_data) +
  geom_sf(aes(geometry = geometry, fill = essence_diff)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank())+
  scale_fill_manual(values = c("#44e26c", "#5a9aee", "#e46262"), labels = c("Essence dominante", "Essence secondaire", "Aucune")) +
  labs(title = "Concordance entre essence objectif et dominante", fill = "Concordance")

```

# Essence, dominance et surface terrière

## Essence dominantes

```{r essence dominante, include=FALSE}
# Summarize on placette to have only un peuplement par unité de gestion
ug_data <- forest_data %>%
  group_by(Identifiant.unité.de.gestion) %>%
  summarise(
    across(all_of(especes), ~ weighted.mean(.x, surface.retenue*surf.terrière.moy, na.rm = TRUE)),
    surface.tot = sum(surface.retenue),
    surf.terrière.moy.tot = sum(surface.retenue * surf.terrière.moy) / sum(surface.retenue)) %>%
  ungroup()

# add essence dominante and put everything as surface terrière
ug_data <- ug_data %>%
  mutate(
    essence.dominante.1 = apply(select(., all_of(especes)), 1, function(x) {
      if (all(is.na(x))) {
        NA_character_
      } else {
        especes[which.max(x)]
      }
    })
  )

essence.dominante <- ug_data %>% 
  select(essence.dominante.1) %>% 
  unique() %>% 
  filter(!is.na(essence.dominante.1))
```

```{r hist essence dominante, echo=FALSE, fig.width = 12, fig.height = 4}
# Plot histogram of dominant species
p1 <- ggplot(ug_data, aes(x = essence.dominante.1)) +
  geom_bar(aes(y = (..count..), fill = essence.dominante.1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Nb d'unité de gestion'", title = "Essence dominante par unité de gestion")
p2 <- ggplot(forest_data, aes(x = Essence.dominante.1)) +
  geom_bar(aes(y = (..count..), fill = Essence.dominante.1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Nb d'unité de peuplement'", title = "Essence dominante par peuplement")
p1 + p2
```

Il y a `r nrow(essence.dominante)` essences qui sont dominantes dans au moins une unité de gestion.
Ce sont : `r paste(unique(essence.dominante), collapse = ", ")`

## Surface terrière

```{r surface terrière, echo=FALSE, fig.width = 12, fig.height = 6}
ug_surf.terrière <- forest_data %>%
  summarize(
    across(all_of(especes), ~ sum(.x * surf.terrière.moy*surface.retenue/100, na.rm = TRUE)),
  ) %>%
  pivot_longer(cols = all_of(especes), names_to = "Essence", values_to = "Surface.terrière") %>%
  mutate(Essence = factor(Essence, levels = especes)) %>%
  arrange(desc(Surface.terrière)) %>%
  mutate(Essence = factor(Essence, levels = unique(Essence)))
surf_tot = sum(forest_data$surface.retenue)

ggplot(ug_surf.terrière, aes(x = Essence, y = Surface.terrière/surf_tot)) +
  geom_col(aes(fill = Essence)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "Surface terrière (m²/ha)", title = "Surface terrière par essence")

essence_surf.terrière <- ug_surf.terrière[1:9,] %>% 
  select(Essence) %>% 
  unique()

st_tot = sum(ug_surf.terrière$Surface.terrière)
st_tot/surf_tot
```

Je propose de garder les essences suivantes pour la modélisation : `r paste(unique(essence_surf.terrière$Essence), collapse = ", ")`

## Espèces objectif

```{r espèce objectif, echo=FALSE, fig.width = 10, fig.height = 6}
forest_data %>% select(ess.obj.SIG) %>% table() %>% as.data.frame() %>% 
  arrange(desc(Freq)) %>% mutate(ess.obj.SIG = factor(ess.obj.SIG, levels = unique(ess.obj.SIG))) -> ess.obj.SIG
ggplot(ess.obj.SIG, aes(x = ess.obj.SIG)) +
  geom_col(aes(y = Freq, fill = ess.obj.SIG)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) +
  theme(legend.position = "none") +
  labs(x = "", y = "% de parcelles", title = "Espèce objectif")

essence.objectif <- forest_data %>% 
  select(ess.obj.SIG) %>% 
  unique() %>% 
  filter(ess.obj.SIG!="SANS")
```

## Correspondance Forceeps

```{r espece forceeps, include=FALSE}
essences <- unique(c(
  essence.dominante,
  essence.objectif,
  essence_surf.terrière %>% pull(Essence) %>% as.character()
)) %>% unlist()
essences <- table(essences) %>% as.data.frame()

forceps_species <- read.csv("data/corresponding_species.csv")
corresponding_species <- forceps_species %>%
  left_join(essences, by = c("Retz_Code" = "essences")) %>% 
  filter(!is.na(Freq))
```

```{r correspondance forceeps tbl, echo = FALSE}
rows_to_highlight <- which(is.na(corresponding_species$Forceps_Code))

# Créer le tableau avec fond rouge pour les lignes correspondantes
corresponding_species  %>%
  kbl(caption = "Espèces Retz et correspondance") %>%
  kable_classic(full_width = FALSE) %>%
  row_spec(rows_to_highlight, background = "#c2bd86")

#forceps_species %>%
#  filter(!is.na(Forceps_Code)) %>%
#  select(Forceps_Code, Latin_Name, French_Name) %>%
#  kbl(caption = "Espèces Forceeps") %>%
#  kable_classic(full_width = FALSE)
```

Pin larico peut-être rattaché à Pinus nigra  
Bouleaux divers peut être associé à Betula pendula  

Les autres n'ont qu'un seul critères, qui est essence dominante, dans seulement les placettes ci dessus : 

```{r essence dominante rare, echo = FALSE}
essence_prb <- c("AUL", "MER","PEU", "TIL", "EPS", "MEL")
forest_data %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill = Essence.dominante.1 %in% essence_prb)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank())+
  scale_fill_manual(values = c("#f5f5f5", "red"), labels = c(FALSE, TRUE)) +
  labs(title = "Surface terrière moyenne", fill = "Essence dominante rare")
```



```{r valeurs, echo = FALSE}
surface_rare = forest_data %>% filter(Essence.dominante.1 %in% essence_prb) %>% pull(surface.retenue) %>% sum()
placette_rare = forest_data %>% filter(Essence.dominante.1 %in% essence_prb) %>% nrow()
surface_tot = forest_data %>% pull(surface.retenue) %>% sum()
placette_tot = forest_data %>% nrow()
```

Je pense que l'on peut les ignorer pour commencer, car ils ne sont pas représentatifs de la forêt de Retz.  

Ce sont `r placette_rare` placettes (sur `r placette_tot` soit `r round(placette_rare/placette_tot*100, 2)` %) pour une surface de `r surface_rare` ha (sur `r surface_tot` ha, soit `r round(surface_rare/surface_tot*100, 2)` %).

```{r tbl rare}
forest_data %>%
  filter(Essence.dominante.1 %in% essence_prb) %>%
  select(Identifiant.peuplement.élémentaire, Essence.dominante.1, Essence.dominante.2, Classe.de.catégorie.de.diamètre.dominant, ess.obj,surface.retenue, surf.terrière.moy) %>%
  rename(
    "Identifiant" = Identifiant.peuplement.élémentaire,
    "Esp Dominante 1" = Essence.dominante.1,
    "Esp Dominante 2" = Essence.dominante.2,
    "Diamètre" = Classe.de.catégorie.de.diamètre.dominant,
    "Esp Objectif" = ess.obj,
    "Surface" = surface.retenue,
    "G moy" = surf.terrière.moy
  ) %>%
  kbl(caption = "Peuplements avec essence rare") %>%
  kable_classic(full_width = FALSE)
```

# Moyenner les peupleument sur les unités de gestion

Pas sure que ça fasse sens, car la taille des peupleuments est plus grande qu'un patch forceeps. On créerai ainsi des bouquets d'arbres qui n'existe pas en ignorant l'hétérogeneité de la parcelle. Il vaut mieux éventuellement ne garder que la surface majoritaire de la parcelle.

```{r, echo = FALSE}
forest_data %>%
  ggplot(aes(x = surface.retenue)) +
  geom_histogram(aes(y = ..density..), bins = 30) +
  geom_density(aes(y = ..density..), color = "blue") +
  theme_minimal() +
  # Ajouter une barre rouge à 0.3
  geom_vline(xintercept = 0.3, color = "red", linetype = "dashed") +
  labs(title = "Distribution de la surface retenue")
```

En rouge la taille maximale d'un patch forceeps. Pour les petites parcelles on peut peut-être concidérer que les deux peuplement cohabitent mais sinon ça n'est peut-être pas pertinent de faire la moyenne sur les peuplements.

# Reserve utile

```{r}
ggplot(forest_data) +
  geom_sf(aes(geometry = geometry, fill = RUM)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank())+
  scale_fill_gradientn(colours = (brewer.pal(11, "Spectral"))) +
  labs(title = "Réserve utile maximale", fill = "(mm)")
```