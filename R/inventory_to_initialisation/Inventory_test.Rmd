---
title: "Analyse des choix de la méthode de génération d'inventaire"
author: "Clémentine de Montgolfier"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

# Analyse des inventaires initiaux

```{r}
load("output/inventory.RData")
```

```{r}
Inventories <- Inventories %>%
    mutate(inventaire_id = paste(distribution, species_proportion, repetition, sep = "_"),
        surf.ter = (pi * ((dbh/100)/2)^2)*10)

ggplot(Inventories, aes(x = inventaire_id, y = surf.ter, fill = factor(speciesId))) +
    geom_bar(stat = "identity", position = "stack")

ggplot(Inventories, aes(x = inventaire_id, fill = factor(speciesId))) +
    geom_bar(position = "fill") +
    scale_y_continuous(labels = scales::percent) +
    labs(y = "Proportion de surface terrière", x = "Inventaire", fill = "Espèce") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Load forceps data
*I need to load all
retz_act.climate_inventaires_{mean, max, min, normal_6, normal_4, unif}_{fixe, random}_{1:5}.inv_simulation_6productivityScene.txt

```{r}
seeds = c(332, 124, 102, 895, 869, 777, 969, 449, 131, 704)
for (i in seeds){
    # Définir le dossier contenant les fichiers
    folder <- 
        paste0("C:/Capsis4/data/forceps/clementine/Test_initialisation/output-cmd_",
        as.character(i), ".txt/")  # Remplace par ton chemin

    # Lister tous les fichiers
    files <- list.files(folder, full.names = TRUE)

    # Patterns à nettoyer
    prefix_pattern <- "^retz_act\\.climate_inventaires_"
    simul_pattern <- "_simulation_([1-9]|10|11)"
    inv_pattern <- "\\.inv"

    # Parcourir et renommer
    for (file in files) {
      filename <- basename(file)
    
      # Effectuer les remplacements
      new_filename <- filename
      new_filename <- sub(prefix_pattern, "", new_filename)
      new_filename <- sub(simul_pattern, "", new_filename)
      new_filename <- sub(inv_pattern, "_", new_filename)  # Remplace .inv par _

      # Renommer si nécessaire
      if (new_filename != filename) {
        old_path <- file.path(folder, filename)
        new_path <- file.path(folder, new_filename)

        file.rename(old_path, new_path)
      }
    }
}

```

load all files avec une colonne seed, une colonne distribution {max, min...}, une colonne species_proportion {fixed ou random}, une colonne repetition {1:5} sachant que les dossiers sont notés : output-cmd_{102}.txt/{max}_{fixe}_{0}_productivityScene.txt

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(purrr)

seeds <- c(332, 124, 102, 895, 869, 777, 969, 449, 131, 704)

# Fonction pour lire et parser chaque fichier
read_forceps_file <- function(seed) {
    folder <- paste0("C:/Capsis4/data/forceps/clementine/Test_initialisation/output-cmd_", seed, ".txt/")
    files <- list.files(folder, pattern = "_productivityScene\\.txt$", full.names = TRUE)
    
    if (length(files) == 0) return(NULL)
    
    map_dfr(files, function(f) {
        # Extraire les infos depuis le nom de fichier
        fname <- basename(f)
        # pattern: {distribution}_{species_proportion}_{repetition}_productivityScene.txt
        m <- str_match(fname, "^(.+?)_([a-zA-Z0-9]+)_([0-9]+)_productivityScene\\.txt$")
        if (is.na(m[1,1])) return(NULL)
        distribution <- m[1,2]
        species_proportion <- m[1,3]
        repetition <- as.integer(m[1,4]) + 1 # +1 car fichiers commencent à 0
        
        # Lire le fichier en ignorant les 11 premières lignes
        df <- read_delim(f, delim = "\t", skip = 11, show_col_types = FALSE)
        df <- df %>%
            mutate(
                seed = seed,
                distribution = distribution,
                species_proportion = species_proportion,
                repetition = repetition
            )
        df
    })
}

# Charger tous les fichiers
forceps_data <- map_dfr(seeds, read_forceps_file)
colnames(forceps_data) <- gsub("#", "", colnames(forceps_data))
```

# Graphe pour 1 seule sedd, distribution, species_proportion, repetition

```{r}
df <- forceps_data %>%
    filter(distribution == "mean", species_proportion == "fixe")

ggplot(df, aes(x = date, y = adultTreeBasalArea, color = factor(speciesId), group = interaction(seed, speciesId))) +
    geom_line() +
    theme_minimal() +
    labs(title = "Internal model variation (seeds)",
         x = "Date",
         y = "Basal Area (m²/ha)",
         color = "Species ID")
```

J'ai l'impression qu'il y a des différences à l'initialisation (pourquoi ? Ca devrait pas)

```{r}
df <- forceps_data %>%
    filter(species_proportion == "fixe")

ggplot(df, aes(x = date, y = adultTreeBasalArea, color = factor(speciesId), group = interaction(seed, speciesId))) +
    geom_line() +
    facet_wrap(~distribution) +
    theme_minimal() +
    labs(title = "Internal model variation (seeds)",
         x = "Date",
         y = "Basal Area (m²/ha)",
         color = "Species ID")

# avec ribbon

summary_df <- df %>%
    group_by(date, speciesId, distribution) %>%
    summarise(
        mean_value = mean(adultTreeBasalArea, na.rm = TRUE),
        lower = min(adultTreeBasalArea, na.rm = TRUE),
        upper = max(adultTreeBasalArea, na.rm = TRUE),
        .groups = "drop"
    )

ggplot(summary_df, aes(x = date, y = mean_value, color = factor(speciesId), fill = factor(speciesId))) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
    geom_line(size = 1) +
    facet_wrap(~distribution) +
    theme_minimal() +
    labs(title = "Internal model variation (seeds)",
         x = "Date",
         y = "Basal Area (m²/ha)",
         color = "Species ID",
         fill = "Species ID")
```

Hypotgèse : c'est le nombre d'arbres qui fait la différence

```{r}
plot_forceps_variation <- function(data, variable, variation = "minmax", mode = "distrib") {
  library(ggplot2)
  library(dplyr)
  library(rlang)

  var_sym <- sym(variable)

  # Appliquer le filtre selon le mode
  filtered_data <- data %>%
    filter(
      (mode == "distribution" & species_proportion == "fixe") |
      (mode == "species_proportion" & distribution == "mean")
    ) %>%
    mutate(
      facet_label = if (mode == "distribution") paste0(distribution, "_", repetition)
                    else paste0(species_proportion, "_", repetition)
    )

    print(table(filtered_data$distribution))

  # Résumer les données
  summary_df <- filtered_data %>%
    filter(!is.na(!!var_sym)) %>%
    group_by(date, speciesId, facet_label) %>%
    summarise(
      mean_value = mean(!!var_sym, na.rm = TRUE),
      lower = if (variation == "minmax") min(!!var_sym, na.rm = TRUE)
              else mean(!!var_sym, na.rm = TRUE) - 1.96 * sd(!!var_sym, na.rm = TRUE) / sqrt(n()),
      upper = if (variation == "minmax") max(!!var_sym, na.rm = TRUE)
              else mean(!!var_sym, na.rm = TRUE) + 1.96 * sd(!!var_sym, na.rm = TRUE) / sqrt(n()),
      .groups = "drop"
    )

  # Créer le graphique
  ggplot(summary_df, aes(x = date, y = mean_value, color = factor(speciesId), fill = factor(speciesId))) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, color = NA) +
    geom_line(size = 1) +
    facet_wrap(~facet_label) +
    theme_minimal() +
    labs(
      title = paste(variable, "par", mode, ifelse(variation == "minmax", "(min–max)", "(IC 95%)")),
      x = "Date",
      y = variable,
      color = "Species ID",
      fill = "Species ID"
    )
}


plot_forceps_variation(forceps_data, "adultTreeBasalArea_m2_ha", "minmax", mode = "species_proportion")
plot_forceps_variation(forceps_data, "adultTreeBiomass_t_ha", "minmax", mode = "species_proportion")
plot_forceps_variation(forceps_data, "deadBiomass_t_ha", "minmax", mode = "species_proportion")
plot_forceps_variation(forceps_data, "adultTreeNumber_ha", "minmax", mode = "species_proportion")
plot_forceps_variation(forceps_data, "saplingNumber_ha", "minmax", mode = "species_proportion")

plot_forceps_variation(forceps_data, "adultTreeBasalArea_m2_ha", "minmax", mode = "distribution")
plot_forceps_variation(forceps_data, "adultTreeBiomass_t_ha", "minmax", mode = "distribution")
plot_forceps_variation(forceps_data, "deadBiomass_t_ha", "minmax", mode = "distribution")
plot_forceps_variation(forceps_data, "adultTreeNumber_ha", "minmax", mode = "distribution")
plot_forceps_variation(forceps_data, "saplingNumber_ha", "minmax", mode = "distribution")
```